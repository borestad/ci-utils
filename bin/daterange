#!/usr/bin/env bash

# date-range: Print dates for the past N days
# Usage: daterange <days> [--from <date>] [--separator <string>]
# <days>: Number of past days to print dates for, including today
# --from <date>: Optional start date in YYYY-MM-DD format
# --separator <string>: Optional string to replace whitespace in output

NUM_CORES=$(getconf _NPROCESSORS_ONLN)

function date-range() {
  if [ -z "$1" ]; then
    echo "Usage: $(basename $0) <days> [--from <date>] [--separator <string>]"
    exit 1
  fi

  local DAYS=$1
  shift

  local START_DATE=$(date +%Y-%m-%d)
  local SEPARATOR=""

  while [[ "$#" -gt 0 ]]; do
    case $1 in
      -from|--from)
        START_DATE="$2"
        shift
        ;;
      -separator|--separator)
        SEPARATOR="$2"
        shift
        ;;
      *)
        echo "Unknown parameter passed: $1"
        exit 1
        ;;
    esac
    shift
  done

  # Generate dates for the past N days and format them
  for (( i=0; i<$DAYS; i++ )); do
    echo "$START_DATE - $i days"
  done | xargs -P $NUM_CORES -I {} date -d "{}" "+%Y-%m-%d" | sort -nr | {
    if [ -n "$SEPARATOR" ]; then
      cat | xargs | tr ' ' "$SEPARATOR"
    else
      cat
    fi
  }
}

date-range "$@"
