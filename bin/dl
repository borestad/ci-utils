#!/usr/bin/env bash

# set -o errexit

#
# Helpers
#
time-now() {
  date +%s.%N
}
benchmark() {
  local start=$1
  local end=${2:-$(time-now)}
  printf %.2f $(echo "$end - $start" | bc -l)
}

#
# Main
#
DIR=$(pwd)
URL=$1
BASENAME=$(basename $URL | sd '\?.*' '')
OUTPUT=${2:-$BASENAME}
TEMPFILE=$(mktemp)
TEMPDIR=$(mktemp -d)

ets -s -f '%s.%Ls ┃ ' \
 curl \
  -# \
  --location \
  --keepalive \
  --connect-timeout 5 \
  --retry 0 \
  --fail-with-body \
  --compressed \
  -o "$TEMPFILE" \
  "${URL}" 2>&1

  code=$?

  if [ $code -ne 0 ]; then
    echo "❌ $URL"
    exit $code
  fi

cd $DIR

mkdir -p "$(dirname "$OUTPUT")"
mv $TEMPFILE $OUTPUT

echo "✅ $URL"
